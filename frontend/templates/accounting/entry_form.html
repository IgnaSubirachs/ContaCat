{% extends "base.html" %}

{% block breadcrumbs %}
<div class="breadcrumb-container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Inici</a></li>
            <li class="breadcrumb-item text-muted">Comptabilitat</li>
            <li class="breadcrumb-item"><a href="/accounting/journal/">Diari</a></li>
            <li class="breadcrumb-item active" aria-current="page">Nou Assentament</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<form action="/accounting/journal/create" method="POST" id="journal-form" enctype="multipart/form-data">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Nou Assentament</h1>
            <p class="text-muted mb-0">Introducció manual d'apunts comptables</p>
        </div>
        <div>
            <a href="/accounting/journal" class="btn btn-outline-secondary me-2">Cancel·lar</a>
            <button type="submit" class="btn btn-primary shadow-sm">
                <i class="fas fa-save me-2"></i> Guardar Assentament
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <!-- General Info Card -->
        <div class="col-lg-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-corporate mb-3">Dades Generals</h5>
                    <div class="row align-items-end">
                        <div class="col-md-2">
                            <label for="date" class="form-label small text-muted">Data</label>
                            <input type="date" class="form-control" id="date" name="date" required value="{{ today }}">
                        </div>
                        <div class="col-md-7">
                            <label for="description" class="form-label small text-muted">Descripció</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i
                                        class="fas fa-pen text-muted"></i></span>
                                <input type="text" class="form-control border-start-0 ps-0" id="description"
                                    name="description" required placeholder="Ex: Factura Llum Endesa...">
                                <button class="btn btn-outline-info" type="button" id="btn-ask-ai"
                                    onclick="manualTriggerAI()" title="Demanar ajuda al Gat">
                                    <i class="fas fa-magic me-1"></i> Suggerir
                                </button>
                            </div>
                            <div id="ai-feedback" class="form-text text-info fw-bold mt-1" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-1"></i> El Gat està pensant...
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="attachment" class="form-label small text-muted">Adjuntar Document</label>
                            <input class="form-control form-control-sm" type="file" id="attachment" name="attachment"
                                accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lines Card -->
    <div class="card border-0 shadow-sm mb-5">
        <div class="card-header bg-light py-3 border-bottom-0 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-corporate">Línies de l'Assentament</h5>
            <div id="balance-status" class="badge bg-success rounded-pill px-3">Equilibrat</div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="lines-table">
                <thead class="bg-light border-bottom">
                    <tr>
                        <th class="ps-4" style="width: 35%;">Compte</th>
                        <th style="width: 30%;">Concepte Línia</th>
                        <th style="width: 15%; text-align: right;">Deure</th>
                        <th style="width: 15%; text-align: right;">Haver</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="lines-body">
                    <!-- Lines added by JS -->
                </tbody>
                <tfoot class="bg-light">
                    <tr>
                        <td colspan="2" class="text-end fw-bold text-muted text-uppercase small pt-3">Totals</td>
                        <td id="total-debit" class="text-end fw-bold pt-3">0.00 €</td>
                        <td id="total-credit" class="text-end fw-bold pt-3">0.00 €</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="card-footer bg-white py-3">
            <button type="button" onclick="addLine()" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-plus me-1"></i> Afegir Línia
            </button>
        </div>
    </div>

</form>

<datalist id="accounts-list">
    {% for account in accounts %}
    <option value="{{ account.code }}">{{ account.code }} - {{ account.name }}</option>
    {% endfor %}
</datalist>

{% endblock %}

{% block scripts %}
<script>
    let lineCount = 0;

    // Initial setup
    document.addEventListener('DOMContentLoaded', function () {
        addLine(); // Add first line
        addLine(); // Add second line

        // AI Listener on main description
        const descInput = document.getElementById('description');
        let timeout = null;

        descInput.addEventListener('input', function () {
            clearTimeout(timeout);
            const feedback = document.getElementById('ai-feedback');

            if (this.value.length < 3) {
                feedback.style.display = 'none';
                return;
            }

            feedback.style.display = 'block';

            timeout = setTimeout(() => {
                fetchSuggestions(this.value);
            }, 800);
        });
    });

    async function fetchSuggestions(text) {
        try {
            const response = await fetch(`/ai/predict-accounts?description=${encodeURIComponent(text)}`);
            if (response.ok) {
                const suggestions = await response.json();
                showSuggestions(suggestions);
            }
        } catch (error) {
            console.error('Error fetching AI suggestions:', error);
        } finally {
            document.getElementById('ai-feedback').style.display = 'none';
        }
    }

    function showSuggestions(suggestions) {
        if (!suggestions || suggestions.length === 0) return;

        // Cat Assistant Integration!
        const top = suggestions[0];
        const msg = `He trobat una coincidència! <br> <strong>${top.account_code} - ${top.account_name}</strong> <br> <small>(${Math.round(top.confidence * 100)}% de confiança)</small>`;

        if (window.catSay) {
            window.catSay(msg, 6000);
        }

        // Auto-fill logic
        const firstRow = document.querySelector('#lines-body tr:first-child');
        if (firstRow) {
            const select = firstRow.querySelector('input[list="accounts-list"]');
            if (select && !select.value) {
                select.value = top.account_code;
                firstRow.querySelector('input[name^="description_"]').value = document.getElementById('description').value;
                // Add a visual cue
                select.classList.add('bg-warning');
                setTimeout(() => select.classList.remove('bg-warning'), 1000);
            }
        }
    }

    function addLine() {
        const tbody = document.getElementById('lines-body');
        const row = document.createElement('tr');

        row.innerHTML = `
            <td class="ps-4">
                <input type="text" class="form-control form-control-sm font-monospace" name="account_code_${lineCount}" list="accounts-list" placeholder="Codi..." required>
            </td>
            <td>
                <input type="text" class="form-control form-control-sm" name="description_${lineCount}" value="${document.getElementById('description').value}">
            </td>
            <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end" name="debit_${lineCount}" value="0.00" onchange="updateTotals()" onfocus="this.select()">
            </td>
            <td>
                <input type="number" step="0.01" class="form-control form-control-sm text-end" name="credit_${lineCount}" value="0.00" onchange="updateTotals()" onfocus="this.select()">
            </td>
            <td class="text-center">
                <button type="button" onclick="removeLine(this)" class="btn btn-link text-danger btn-sm p-0">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;

        tbody.appendChild(row);
        lineCount++;
    }

    function removeLine(btn) {
        const row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
        updateTotals();
    }

    function updateTotals() {
        let totalDebit = 0;
        let totalCredit = 0;

        document.querySelectorAll('input[name^="debit_"]').forEach(input => totalDebit += parseFloat(input.value || 0));
        document.querySelectorAll('input[name^="credit_"]').forEach(input => totalCredit += parseFloat(input.value || 0));

        document.getElementById('total-debit').textContent = totalDebit.toFixed(2) + ' €';
        document.getElementById('total-credit').textContent = totalCredit.toFixed(2) + ' €';

        const diff = Math.abs(totalDebit - totalCredit);
        const status = document.getElementById('balance-status');

        if (diff < 0.01) {
            status.textContent = "Equilibrat";
            status.className = "badge bg-success rounded-pill px-3";
        } else {
            status.textContent = "Desequilibrat (" + diff.toFixed(2) + " €)";
            status.className = "badge bg-danger rounded-pill px-3";
        }
    }
</script>
{% endblock %}