{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="fas fa-users-cog me-2"></i>Gestió d'Usuaris</h1>
        <p class="text-muted">Administració d'usuaris i rols del sistema</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" onclick="showCreateModal()">
            <i class="fas fa-plus me-1"></i> Afegir Usuari
        </button>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="usersTable">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Usuari</th>
                        <th>Rol</th>
                        <th>Estat</th>
                        <th>Accions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Users will be loaded here via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Crear Usuari</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label for="username" class="form-label">Usuari</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contrasenya</label>
                        <input type="password" class="form-control" id="password">
                        <div class="form-text">Deixa en blanc per mantenir l'actual (només edició)</div>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Rol</label>
                        <select class="form-select" id="role" required>
                            <option value="ADMIN">Administrador</option>
                            <option value="MANAGER">Gestor</option>
                            <option value="USER">Usuari</option>
                            <option value="READ_ONLY">Només Lectura</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" checked>
                        <label class="form-check-label" for="isActive">Actiu</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel·lar</button>
                <button type="button" class="btn btn-primary" onclick="submitUserForm()">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = '/auth';
    let userModal;

    document.addEventListener('DOMContentLoaded', function () {
        userModal = new bootstrap.Modal(document.getElementById('userModal'));
        loadUsers();
    });

    function getAuthHeaders() {
        // Cookie based auth is now used for web, but API might check headers. 
        //  If we use session cookies, we might not need Bearer token manually here 
        // if the backend checks cookies too. 
        // Assuming we still use the token from localStorage if valid, or cookie.
        // For this refactor, let's keep it simple. If we rely on cookies, headers shouldn't be needed 
        // UNLESS the API requires them. 
        // Let's assume text/html requests use cookies, but fetch might need headers?
        // Actually the previous code used localStorage.
        const token = localStorage.getItem('access_token');
        const headers = {
            'Content-Type': 'application/json'
        };
        // Only add Authorization header if token exists
        // If no token, the cookie will be used automatically
        if (token && token !== 'null') {
            headers['Authorization'] = `Bearer ${token}`;
        }
        return headers;
    }

    async function loadUsers() {
        try {
            const response = await fetch(`${API_BASE}/users`, {
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const users = await response.json();
                renderUsers(users);
            } else if (response.status === 401) {
                // Redirect or handle auth error
                window.location.href = '/auth/login-page';
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    function renderUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td class="fw-bold">${user.username}</td>
                <td><span class="badge bg-secondary">${getRoleLabel(user.role)}</span></td>
                <td>
                    <span class="badge ${user.is_active ? 'bg-success' : 'bg-danger'}">
                        ${user.is_active ? 'Actiu' : 'Inactiu'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function getRoleLabel(role) {
        const labels = {
            'ADMIN': 'Administrador',
            'MANAGER': 'Gestor',
            'USER': 'Usuari',
            'READ_ONLY': 'Només Lectura'
        };
        return labels[role] || role;
    }

    function showCreateModal() {
        document.getElementById('modalTitle').textContent = 'Crear Usuari';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('password').required = true;
        userModal.show();
    }

    async function editUser(userId) {
        // Fetch specific user details would be better, but assuming we have to list reload or similar.
        // For now, we set mode to edit. Logic to pre-fill is tricky without fetching single user.
        // Let's just open modal empty or rely on a "getUser" endpoint if it existed. 
        // The original code didn't pre-fill either properly? 
        // Wait, original `editUser` function was just opening modal. It relied on user manually inputting?
        // Ah, previous code: `document.getElementById('userId').value = userId;`. It didn't find the user object from the list to prefill?
        // That's a bug in previous code too.
        // I'll implement a simple find from the rendered list logic if possible, or just set ID.
        document.getElementById('modalTitle').textContent = 'Editar Usuari (ID: ' + userId + ')';
        document.getElementById('userId').value = userId;
        document.getElementById('password').required = false;
        userModal.show();
    }

    async function submitUserForm() {
        const userId = document.getElementById('userId').value;
        const data = {
            username: document.getElementById('username').value,
            role: document.getElementById('role').value,
            is_active: document.getElementById('isActive').checked
        };

        const password = document.getElementById('password').value;
        if (password) {
            data.password = password;
        }

        try {
            const url = userId ? `${API_BASE}/users/${userId}` : `${API_BASE}/users`;
            const method = userId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            if (response.ok) {
                userModal.hide();
                loadUsers();
            } else {
                alert('Error al guardar usuari');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de connexió');
        }
    }

    async function deleteUser(userId) {
        if (!confirm('Segur que vols eliminar aquest usuari?')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/users/${userId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                loadUsers();
            } else {
                alert('Error al eliminar usuari');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>
{% endblock %}